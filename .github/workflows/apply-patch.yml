name: apply-patch
on:
  workflow_dispatch:
    inputs:
      url:
        description: "URL cruda del diff (Gist Raw o similar)"
        required: true
        type: string
      sha256:
        description: "Hash SHA256 opcional del diff"
        required: false
        type: string
      commit_direct:
        description: "Commit directo a la rama por defecto"
        required: true
        default: "false"
        type: choice
        options: ["false","true"]

permissions:
  contents: write
  pull-requests: write

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Descargar diff (solo URL)
        run: |
          set -euo pipefail
          curl -fsSL "${{ github.event.inputs.url }}" -o /tmp/patch.diff
          if [ -n "${{ github.event.inputs.sha256 }}" ]; then
            echo "${{ github.event.inputs.sha256 }}  /tmp/patch.diff" | sha256sum -c -
          fi
          sed -i 's/\r$//' /tmp/patch.diff

      - name: Detectar rama por defecto
        id: def
        run: |
          DEF=$(git remote show origin | sed -n 's/^\s*HEAD branch: //p')
          echo "def=$DEF" >> $GITHUB_OUTPUT

      - name: Aplicar patch (3-way)
        run: |
          git apply --index --3way --whitespace=fix /tmp/patch.diff

      - name: Crear PR
        if: ${{ github.event.inputs.commit_direct != 'true' }}
        uses: peter-evans/create-pull-request@v7
        with:
          title: "hope: apply patch (url only)"
          branch: hope/apply-${{ github.run_id }}
          commit-message: "hope: apply patch"
          delete-branch: true

      - name: Autor del commit (directo)
        if: ${{ github.event.inputs.commit_direct == 'true' }}
        run: |
          git config user.name  "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Commit y push directo
        if: ${{ github.event.inputs.commit_direct == 'true' }}
        env:
          TOKEN: ${{ secrets.PAT_PUSH || secrets.GITHUB_TOKEN }}
        run: |
          git commit -m "hope: apply patch"
          git push https://$TOKEN@github.com/${{ github.repository }} HEAD:${{ steps.def.outputs.def }}
